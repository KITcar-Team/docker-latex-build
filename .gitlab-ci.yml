stages:
  - lint
  - stage
  - deploy

lint-dockerfile:
  type: lint
  image: projectatomic/dockerfile-lint
  script:
    - dockerfile_lint -p Dockerfile


# Build and deploy the CI docker image to the gitlab registry
# This is done everytime the master branch is updated
stage-docker:
  image: docker:19.03.11
  tags:
  - docker
  services:
  - docker:19.03.11-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ''
  stage: deploy
  dependencies:
    - lint-dockerfile
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY 
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME

